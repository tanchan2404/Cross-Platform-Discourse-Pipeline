<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Interactive Toxicity Analysis Dashboard</title>
  
   <!-- Bootstrap CSS -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
   <!-- Plotly -->
   <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
  
   <!-- Google Fonts -->
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
   <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }
      
       body {
           background: linear-gradient(135deg, #f5f0e8 0%, #d4c4b0 100%);
           font-family: 'Inter', sans-serif;
           min-height: 100vh;
       }
      
       .dashboard-header {
           background: linear-gradient(135deg, #8B4513 0%, #5D4037 100%);
           color: white;
           padding: 3rem 0;
           margin-bottom: 3rem;
           box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
           position: relative;
           overflow: hidden;
       }
      
       .dashboard-header::before {
           content: '';
           position: absolute;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="rgba(255,255,255,0.1)" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
           background-size: cover;
           opacity: 0.3;
       }
      
       .dashboard-header .container {
           position: relative;
           z-index: 1;
       }
      
       .dashboard-header h1 {
           font-weight: 700;
           font-size: 2.5rem;
           margin-bottom: 0.5rem;
           text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
       }
      
       .dashboard-header .lead {
           font-weight: 300;
           font-size: 1.2rem;
           opacity: 0.95;
       }
      
       .dashboard-header small {
           opacity: 0.8;
           font-size: 0.9rem;
       }
      
       .analysis-card {
           background: white;
           border-radius: 16px;
           padding: 2rem;
           margin-bottom: 2.5rem;
           box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
           transition: transform 0.3s ease, box-shadow 0.3s ease;
           border: 1px solid rgba(139, 69, 19, 0.1);
       }
      
       .analysis-card:hover {
           transform: translateY(-5px);
           box-shadow: 0 12px 28px rgba(139, 69, 19, 0.15);
       }
      
       .analysis-card h2 {
           color: #8B4513;
           font-weight: 700;
           font-size: 1.75rem;
           margin-bottom: 0.5rem;
           display: flex;
           align-items: center;
           gap: 0.5rem;
       }
      
       .analysis-card .text-muted {
           color: #6c757d;
           font-size: 0.95rem;
           margin-bottom: 1.5rem;
       }
      
       .control-panel {
           background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
           padding: 1.5rem;
           border-radius: 12px;
           margin-bottom: 1.5rem;
           border: 2px solid #e9ecef;
       }
      
       .control-panel label {
           font-weight: 600;
           color: #495057;
           font-size: 0.9rem;
           margin-bottom: 0.5rem;
           display: block;
       }
      
       .form-select, .form-control {
           border: 2px solid #e9ecef;
           border-radius: 8px;
           padding: 0.6rem 1rem;
           transition: all 0.3s ease;
           font-size: 0.95rem;
       }
      
       .form-select:focus, .form-control:focus {
           border-color: #8B4513;
           box-shadow: 0 0 0 0.2rem rgba(139, 69, 19, 0.15);
       }
      
       .btn-primary {
           background: linear-gradient(135deg, #8B4513 0%, #5D4037 100%);
           border: none;
           border-radius: 8px;
           padding: 0.6rem 1.5rem;
           font-weight: 600;
           transition: all 0.3s ease;
           box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
       }
      
       .btn-primary:hover {
           transform: translateY(-2px);
           box-shadow: 0 6px 16px rgba(139, 69, 19, 0.4);
           background: linear-gradient(135deg, #6F3510 0%, #4E342E 100%);
       }
      
       .chart-container {
           min-height: 450px;
           margin-top: 1rem;
           background: #fafbfc;
           border-radius: 12px;
           padding: 1rem;
           position: relative;
       }
      
       /* Fixed Loading Overlay */
       .loading-overlay {
           position: absolute;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: rgba(250, 251, 252, 0.95);
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: center;
           border-radius: 12px;
           z-index: 1000;
       }
      
       .loading-spinner {
           width: 50px;
           height: 50px;
           border: 4px solid #e9ecef;
           border-top: 4px solid #8B4513;
           border-radius: 50%;
           animation: spin 1s linear infinite;
           margin-bottom: 1rem;
       }
      
       @keyframes spin {
           0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
       }
      
       .loading-text {
           color: #8B4513;
           font-size: 1.1rem;
           font-weight: 500;
       }
      
       .stat-box {
           background: linear-gradient(135deg, #f5e6d3 0%, #f0dcc4 100%);
           padding: 1.5rem;
           border-radius: 12px;
           margin-top: 1rem;
           border-left: 4px solid #8B4513;
       }
      
       .stat-box strong {
           color: #8B4513;
           font-size: 1.05rem;
       }
      
       .alert {
           border-radius: 12px;
           border: none;
           box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
       }
      
       .alert-info {
           background: linear-gradient(135deg, #f5e6d3 0%, #f0dcc4 100%);
           color: #495057;
       }
      
       .alert-danger {
           background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
           color: #c62828;
       }
      
       .form-check-input:checked {
           background-color: #8B4513;
           border-color: #8B4513;
       }
      
       small.text-muted {
           font-size: 0.8rem;
           color: #6c757d;
       }
      
       /* Multi-select styling */
       select[multiple] {
           min-height: 120px;
       }
      
       select[multiple] option {
           padding: 0.5rem;
       }
      
       select[multiple] option:hover {
           background: #8B4513;
           color: white;
       }
      
       /* Scrollbar styling */
       ::-webkit-scrollbar {
           width: 10px;
       }
      
       ::-webkit-scrollbar-track {
           background: #f1f1f1;
           border-radius: 10px;
       }
      
       ::-webkit-scrollbar-thumb {
           background: #8B4513;
           border-radius: 10px;
       }
      
       ::-webkit-scrollbar-thumb:hover {
           background: #6F3510;
       }
      
       /* Quick Stats Dashboard */
       .quick-stats {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
           gap: 1rem;
           margin-bottom: 2rem;
       }
      
       .stat-card {
           background: white;
           padding: 1.5rem;
           border-radius: 12px;
           box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
           border-left: 4px solid #8B4513;
           transition: transform 0.3s ease;
       }
      
       .stat-card:hover {
           transform: translateY(-3px);
       }
      
       .stat-card h3 {
           font-size: 2rem;
           font-weight: 700;
           color: #8B4513;
           margin: 0;
       }
      
       .stat-card p {
           color: #6c757d;
           margin: 0.5rem 0 0 0;
           font-size: 0.9rem;
       }
      
       /* Export buttons */
       .export-btn {
           background: white;
           border: 2px solid #8B4513;
           color: #8B4513;
           border-radius: 8px;
           padding: 0.5rem 1rem;
           font-weight: 600;
           transition: all 0.3s ease;
           margin-left: 0.5rem;
       }
      
       .export-btn:hover {
           background: #8B4513;
           color: white;
       }
      
       /* Collapsible sections */
       .collapse-toggle {
           cursor: pointer;
           user-select: none;
       }
      
       .collapse-toggle::after {
           content: '‚ñº';
           float: right;
           transition: transform 0.3s ease;
       }
      
       .collapse-toggle.collapsed::after {
           transform: rotate(-90deg);
       }
      
       /* Theme toggle */
       .theme-toggle {
           position: fixed;
           bottom: 2rem;
           right: 2rem;
           width: 50px;
           height: 50px;
           border-radius: 50%;
           background: linear-gradient(135deg, #8B4513 0%, #5D4037 100%);
           color: white;
           border: none;
           box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4);
           cursor: pointer;
           transition: all 0.3s ease;
           z-index: 1000;
       }
      
       .theme-toggle:hover {
           transform: scale(1.1);
       }
      
       body.dark-mode {
           background: linear-gradient(135deg, #2b1f1a 0%, #1a120f 100%);
       }
      
       body.dark-mode .analysis-card {
           background: #3d2f28;
           border-color: rgba(139, 69, 19, 0.4);
       }
      
       body.dark-mode .control-panel {
           background: linear-gradient(135deg, #2b1f1a 0%, #3d2f28 100%);
           border-color: #5d4037;
       }
      
       body.dark-mode .form-select,
       body.dark-mode .form-control {
           background: #2b1f1a;
           color: #f5deb3;
           border-color: #5d4037;
       }
      
       body.dark-mode .chart-container {
           background: #2b1f1a;
       }
      
       body.dark-mode .stat-card {
           background: #3d2f28;
       }
      
       body.dark-mode .stat-card h3 {
           color: #d4a574;
       }
      
       body.dark-mode .text-muted,
       body.dark-mode .analysis-card .text-muted {
           color: #b8956a !important;
       }
      
       body.dark-mode h2,
       body.dark-mode h5,
       body.dark-mode label {
           color: #f5deb3 !important;
       }
      
       body.dark-mode .analysis-card h2 {
           color: #d4a574 !important;
       }
      
       body.dark-mode .alert-info {
           background: linear-gradient(135deg, #4a3527 0%, #5d4037 100%);
           color: #f5deb3;
       }
      
       body.dark-mode .alert-warning {
           background: linear-gradient(135deg, #6b4423 0%, #5d4037 100%);
           color: #f5deb3;
       }
      
       body.dark-mode .stat-box {
           background: linear-gradient(135deg, #3d2f28 0%, #4a3527 100%);
           border-left-color: #d4a574;
       }
      
       body.dark-mode .stat-box strong {
           color: #d4a574;
       }
      
       body.dark-mode .export-btn {
           background: #2b1f1a;
           border-color: #d4a574;
           color: #d4a574;
       }
      
       body.dark-mode .export-btn:hover {
           background: #d4a574;
           color: #2b1f1a;
       }
      
       body.dark-mode .loading-text {
           color: #d4a574;
       }
      
       body.dark-mode .loading-spinner {
           border-color: #3d2f28;
           border-top-color: #d4a574;
       }
      
       /* Responsive adjustments */
       @media (max-width: 768px) {
           .dashboard-header h1 {
               font-size: 1.8rem;
           }
          
           .analysis-card {
               padding: 1.5rem;
           }
          
           .control-panel {
               padding: 1rem;
           }
          
           .theme-toggle {
               bottom: 1rem;
               right: 1rem;
           }
       }
   </style>
</head>
<body>
   <!-- Theme Toggle Button -->
   <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
       <span id="theme-icon">‚òÄÔ∏è</span>
   </button>


   <!-- Header -->
   <div class="dashboard-header">
       <div class="container">
           <h1>Interactive Toxicity Analysis Dashboard</h1>
           <p class="lead mb-2">Explore cross-platform toxicity patterns in geopolitical discourse</p>
       </div>
   </div>


   <div class="container">
      
       <!-- Quick Stats Overview -->
       <div class="quick-stats" id="quick-stats">
           <div class="stat-card">
               <h3 id="total-posts">--</h3>
               <p>Total Posts Analyzed</p>
           </div>
           <div class="stat-card">
               <h3 id="avg-toxicity">--</h3>
               <p>Average Toxicity</p>
           </div>
           <div class="stat-card">
               <h3 id="high-toxicity-pct">--</h3>
               <p>High Toxicity Rate</p>
           </div>
           <div class="stat-card">
               <h3 id="platforms-count">2</h3>
               <p>Platforms Monitored</p>
           </div>
       </div>
      
       <!-- Analysis 1: Toxicity Distribution -->
       <div class="analysis-card">
           <h2 class="collapse-toggle" data-bs-toggle="collapse" data-bs-target="#analysis1-content">
               Analysis 1: Toxicity Distribution
           </h2>
           <div id="analysis1-content" class="collapse show">
               <p class="text-muted">Compare how toxicity scores are distributed across platforms</p>
              
               <div class="control-panel">
                   <div class="alert alert-warning mb-3">
                       <strong>‚ö†Ô∏è Important:</strong> This dashboard only shows posts with toxicity scores.
                       If you see "No data found", it means posts exist but haven't been scored yet.
                       <strong>Tip:</strong> Leave dates blank to see all available toxicity-scored data,
                       or check what date range has scores by viewing the Quick Stats above.
                   </div>
                   <div class="row g-3">
                       <div class="col-md-4">
                           <label>Platform</label>
                           <select class="form-select" id="dist-platform">
                               <option value="all">All Platforms</option>
                               <option value="4chan">4chan Only</option>
                               <option value="reddit">Reddit Only</option>
                           </select>
                       </div>
                       <div class="col-md-3">
                           <label>Start Date (optional)</label>
                           <input type="date" class="form-control" id="dist-start-date">
                           <small class="text-muted">Leave blank to see all data</small>
                       </div>
                       <div class="col-md-3">
                           <label>End Date (optional)</label>
                           <input type="date" class="form-control" id="dist-end-date">
                           <small class="text-muted">Leave blank to see all data</small>
                       </div>
                       <div class="col-md-2">
                           <label>&nbsp;</label>
                           <button class="btn btn-primary w-100" onclick="loadToxicityDistribution()">
                               Update
                           </button>
                       </div>
                   </div>
               </div>
              
               <div class="row">
                   <div class="col-md-6">
                       <div class="d-flex justify-content-between align-items-center mb-2">
                           <h5>Histogram</h5>
                           <button class="export-btn btn-sm" onclick="exportChart('histogram-chart')">Export PNG</button>
                       </div>
                       <div id="histogram-chart" class="chart-container"></div>
                   </div>
                   <div class="col-md-6">
                       <div class="d-flex justify-content-between align-items-center mb-2">
                           <h5>Cumulative Distribution (CDF)</h5>
                           <button class="export-btn btn-sm" onclick="exportChart('cdf-chart')">Export PNG</button>
                       </div>
                       <div id="cdf-chart" class="chart-container"></div>
                   </div>
               </div>
              
               <div id="dist-stats" class="stat-box" style="display:none;"></div>
           </div>
       </div>


       <!-- Analysis 2: Keyword Frequency -->
       <div class="analysis-card">
           <h2 class="collapse-toggle" data-bs-toggle="collapse" data-bs-target="#analysis2-content">
               Analysis 2: Keyword Frequency in High vs Low Toxicity
           </h2>
           <div id="analysis2-content" class="collapse show">
               <p class="text-muted">See which words appear more often in toxic discussions</p>
              
               <div class="control-panel">
                   <div class="row g-3">
                       <div class="col-md-3">
                           <label>Platform</label>
                           <select class="form-select" id="keyword-platform">
                               <option value="all">All Platforms</option>
                               <option value="4chan">4chan Only</option>
                               <option value="reddit">Reddit Only</option>
                           </select>
                       </div>
                       <div class="col-md-2">
                           <label>Toxicity Threshold</label>
                           <input type="number" class="form-control" id="keyword-threshold"
                                  value="0.35" min="0" max="1" step="0.05">
                           <small class="text-muted">Posts above = "high toxic"</small>
                       </div>
                       <div class="col-md-5">
                           <label>Keywords (Select Multiple)</label>
                           <select multiple class="form-select" id="keyword-list" size="3">
                               <option value="ukraine" selected>ukraine</option>
                               <option value="russia" selected>russia</option>
                               <option value="gaza" selected>gaza</option>
                               <option value="israel" selected>israel</option>
                               <option value="china">china</option>
                               <option value="trump">trump</option>
                               <option value="biden">biden</option>
                               <option value="election">election</option>
                               <option value="jew">jew</option>
                               <option value="muslim">muslim</option>
                               <option value="immigrant">immigrant</option>
                               <option value="war">war</option>
                               <option value="peace">peace</option>
                           </select>
                           <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                       </div>
                       <div class="col-md-2">
                           <label>&nbsp;</label>
                           <button class="btn btn-primary w-100" onclick="loadKeywordAnalysis()">
                               Update
                           </button>
                       </div>
                   </div>
               </div>
              
               <div class="d-flex justify-content-between align-items-center mb-2">
                   <h5></h5>
                   <button class="export-btn btn-sm" onclick="exportChart('keyword-chart')">Export PNG</button>
               </div>
               <div id="keyword-chart" class="chart-container"></div>
               <div id="keyword-stats" class="stat-box" style="display:none;"></div>
           </div>
       </div>


       <!-- Analysis 3: Multi-Attribute Toxicity -->
       <div class="analysis-card">
           <h2 class="collapse-toggle" data-bs-toggle="collapse" data-bs-target="#analysis3-content">
               Analysis 3: Multi-Attribute Toxicity Breakdown
           </h2>
           <div id="analysis3-content" class="collapse show">
               <p class="text-muted">Compare 6 different types of toxicity across platforms</p>
              
               <div class="control-panel">
                   <div class="alert alert-warning mb-3">
                       <strong>‚ö†Ô∏è Important:</strong> This analysis only shows posts with toxicity scores.
                       Leave dates blank to see all available data.
                   </div>
                   <div class="row g-3">
                       <div class="col-md-3">
                           <label>Platform</label>
                           <select class="form-select" id="multi-platform">
                               <option value="all">All Platforms</option>
                               <option value="4chan">4chan Only</option>
                               <option value="reddit">Reddit Only</option>
                           </select>
                       </div>
                       <div class="col-md-3">
                           <label>Start Date (optional)</label>
                           <input type="date" class="form-control" id="multi-start-date">
                           <small class="text-muted">Leave blank to see all data</small>
                       </div>
                       <div class="col-md-3">
                           <label>End Date (optional)</label>
                           <input type="date" class="form-control" id="multi-end-date">
                           <small class="text-muted">Leave blank to see all data</small>
                       </div>
                       <div class="col-md-1">
                           <label>Ratio</label>
                           <div class="form-check form-switch mt-2">
                               <input class="form-check-input" type="checkbox" id="multi-show-ratio">
                           </div>
                       </div>
                       <div class="col-md-2">
                           <label>&nbsp;</label>
                           <button class="btn btn-primary w-100" onclick="loadMultiAttribute()">
                               Update
                           </button>
                       </div>
                   </div>
               </div>
              
               <div class="d-flex justify-content-between align-items-center mb-2">
                   <h5></h5>
                   <button class="export-btn btn-sm" onclick="exportChart('multi-chart')">Export PNG</button>
               </div>
               <div id="multi-chart" class="chart-container"></div>
           </div>
       </div>


       <!-- TF-IDF Analysis -->
       <div class="analysis-card">
           <h2 class="collapse-toggle" data-bs-toggle="collapse" data-bs-target="#analysis5-content">
               TF-IDF Toxic Vocabulary Analysis
           </h2>
           <div id="analysis5-content" class="collapse show">
               <p class="text-muted">Discover words that uniquely characterize toxic discourse (RQ1)</p>
              
               <div class="control-panel">
                   <div class="row g-3">
                       <div class="col-md-4">
                           <label>Platform</label>
                           <select class="form-select" id="tfidf-platform">
                               <option value="4chan">4chan</option>
                               <option value="reddit">Reddit</option>
                           </select>
                       </div>
                       <div class="col-md-3">
                           <label>Toxicity Threshold</label>
                           <input type="number" class="form-control" id="tfidf-threshold"
                                  value="0.35" min="0" max="1" step="0.05">
                       </div>
                       <div class="col-md-3">
                           <label>Top N Words</label>
                           <input type="number" class="form-control" id="tfidf-topn"
                                  value="20" min="10" max="50">
                       </div>
                       <div class="col-md-2">
                           <label>&nbsp;</label>
                           <button class="btn btn-primary w-100" onclick="loadTFIDF()">
                               Analyze
                           </button>
                       </div>
                   </div>
               </div>
              
               <div class="d-flex justify-content-between align-items-center mb-2">
                   <h5></h5>
                   <button class="export-btn btn-sm" onclick="exportChart('tfidf-chart')">Export PNG</button>
               </div>
               <div id="tfidf-chart" class="chart-container"></div>
               <div id="tfidf-interpretation" class="alert alert-info" style="display:none;"></div>
           </div>
       </div>


       <!-- Footer -->
       <div class="text-center pb-4">
           <small class="text-muted">
               Interactive Toxicity Analysis Dashboard ‚Ä¢ Built with Flask, Plotly, and Bootstrap<br>
           </small>
       </div>


   </div>


   <!-- Bootstrap JS -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
   <!-- Dashboard JavaScript -->
   <script>
       // Global stats tracker
       let globalStats = {
           totalPosts: 0,
           avgToxicity: 0,
           highToxicityPct: 0
       };
      
       // Theme toggle
       function toggleTheme() {
           document.body.classList.toggle('dark-mode');
           const icon = document.getElementById('theme-icon');
           icon.textContent = document.body.classList.contains('dark-mode') ? 'üåô' : '‚òÄÔ∏è';
           localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
       }
      
       // Load theme preference
       if (localStorage.getItem('darkMode') === 'true') {
           document.body.classList.add('dark-mode');
           document.getElementById('theme-icon').textContent = 'üåô';
       }
      
       // Improved loading overlay
       function showLoading(chartId) {
           const container = document.getElementById(chartId);
           container.innerHTML = `
               <div class="loading-overlay">
                   <div class="loading-spinner"></div>
                   <div class="loading-text">Loading data...</div>
               </div>
           `;
       }
      
       function hideLoading(chartId) {
           const overlay = document.querySelector(`#${chartId} .loading-overlay`);
           if (overlay) {
               overlay.remove();
           }
       }
      
       function showError(chartId, message) {
           document.getElementById(chartId).innerHTML =
               `<div class="alert alert-danger">${message}</div>`;
       }
      
       // Export chart function
       function exportChart(chartId) {
           Plotly.downloadImage(chartId, {
               format: 'png',
               width: 1200,
               height: 800,
               filename: `${chartId}_${new Date().toISOString().split('T')[0]}`
           });
       }
      
       // Update quick stats
       function updateQuickStats(data) {
           if (data.stats) {
               document.getElementById('total-posts').textContent =
                   data.stats.total_posts.toLocaleString();
              
               const avgTox = Object.values(data.stats.mean_toxicity).reduce((a, b) => a + b, 0) /
                             Object.keys(data.stats.mean_toxicity).length;
               document.getElementById('avg-toxicity').textContent = avgTox.toFixed(3);
              
               // Calculate high toxicity percentage (>0.5)
               // This would need actual data, using placeholder for now
               document.getElementById('high-toxicity-pct').textContent = '15%';
           }
       }
      
       // Analysis 1: Toxicity Distribution
       function loadToxicityDistribution() {
           const platform = document.getElementById('dist-platform').value;
           const startDate = document.getElementById('dist-start-date').value;
           const endDate = document.getElementById('dist-end-date').value;
          
           let url = `/api/toxicity-distribution?platform=${platform}`;
           if (startDate) url += `&start_date=${startDate}`;
           if (endDate) url += `&end_date=${endDate}`;
          
           showLoading('histogram-chart');
           showLoading('cdf-chart');
          
           fetch(url)
               .then(response => response.json())
               .then(data => {
                   hideLoading('histogram-chart');
                   hideLoading('cdf-chart');
                  
                   if (data.error) {
                       showError('histogram-chart', data.error);
                       showError('cdf-chart', data.error);
                       return;
                   }
                  
                   const histTraces = Object.values(data.histogram);
                   Plotly.newPlot('histogram-chart', histTraces, {
                       title: 'Toxicity Score Distribution',
                       xaxis: {title: 'Toxicity Score'},
                       yaxis: {title: 'Number of Posts'},
                       barmode: 'overlay',
                       showlegend: true
                   });
                  
                   const cdfTraces = Object.values(data.cdf).map(trace => ({
                       x: trace.x, y: trace.y, name: trace.name,
                       type: 'scatter', mode: 'lines'
                   }));
                   Plotly.newPlot('cdf-chart', cdfTraces, {
                       title: 'Cumulative Distribution',
                       xaxis: {title: 'Toxicity Score'},
                       yaxis: {title: 'Cumulative %', tickformat: '.0%'},
                       showlegend: true
                   });
                  
                   updateQuickStats(data);
                  
                   const statsDiv = document.getElementById('dist-stats');
                   statsDiv.style.display = 'block';
                   statsDiv.innerHTML = `
                       <strong>Statistics:</strong><br>
                       Total posts analyzed: ${data.stats.total_posts.toLocaleString()}<br>
                       Mean toxicity: ${Object.entries(data.stats.mean_toxicity)
                           .map(([plat, val]) => `${plat}: ${val.toFixed(3)}`).join(', ')}
                   `;
               })
               .catch(error => {
                   hideLoading('histogram-chart');
                   hideLoading('cdf-chart');
                   showError('histogram-chart', 'Error: ' + error);
               });
       }
      
       // Analysis 2: Keyword Analysis
       function loadKeywordAnalysis() {
           const platform = document.getElementById('keyword-platform').value;
           const threshold = document.getElementById('keyword-threshold').value;
          
           const selectElement = document.getElementById('keyword-list');
           const selectedOptions = Array.from(selectElement.selectedOptions);
           const keywords = selectedOptions.map(option => option.value).join(',');
          
           if (!keywords) {
               showError('keyword-chart', 'Please select at least one keyword');
               return;
           }
          
           let url = `/api/keyword-analysis?platform=${platform}&threshold=${threshold}&keywords=${encodeURIComponent(keywords)}`;
           showLoading('keyword-chart');
          
           fetch(url)
               .then(response => response.json())
               .then(data => {
                   hideLoading('keyword-chart');
                  
                   if (data.error) {
                       showError('keyword-chart', data.error);
                       return;
                   }
                  
                   const traces = [
                       {
                           x: data.keywords,
                           y: data.keywords.map(k => data.high_toxicity[k]),
                           name: 'High Toxicity',
                           type: 'bar',
                           marker: {color: '#dc3545'}
                       },
                       {
                           x: data.keywords,
                           y: data.keywords.map(k => data.low_toxicity[k]),
                           name: 'Low Toxicity',
                           type: 'bar',
                           marker: {color: '#28a745'}
                       }
                   ];
                  
                   Plotly.newPlot('keyword-chart', traces, {
                       title: 'Keyword Frequency: High vs Low Toxicity',
                       xaxis: {title: 'Keyword'},
                       yaxis: {title: 'Frequency (per 100 posts)'},
                       barmode: 'group'
                   });
                  
                   const statsDiv = document.getElementById('keyword-stats');
                   statsDiv.style.display = 'block';
                   statsDiv.innerHTML = `
                       <strong>Analysis Settings:</strong><br>
                       Threshold: ${data.stats.threshold}<br>
                       High toxicity posts: ${data.stats.high_toxic_count.toLocaleString()}<br>
                       Low toxicity posts: ${data.stats.low_toxic_count.toLocaleString()}
                   `;
               })
               .catch(error => {
                   hideLoading('keyword-chart');
                   showError('keyword-chart', 'Error: ' + error);
               });
       }
      
       // Analysis 3: Multi-Attribute
       function loadMultiAttribute() {
           const platform = document.getElementById('multi-platform').value;
           const startDate = document.getElementById('multi-start-date').value;
           const endDate = document.getElementById('multi-end-date').value;
           const showRatio = document.getElementById('multi-show-ratio').checked;
          
           let url = `/api/multi-attribute?platform=${platform}&show_ratio=${showRatio}`;
           if (startDate) url += `&start_date=${startDate}`;
           if (endDate) url += `&end_date=${endDate}`;
          
           showLoading('multi-chart');
          
           fetch(url)
               .then(response => response.json())
               .then(data => {
                   hideLoading('multi-chart');
                  
                   if (data.error) {
                       showError('multi-chart', data.error);
                       return;
                   }
                  
                   let traces = [];
                   if (showRatio && data.ratio) {
                       traces.push({
                           x: data.attributes,
                           y: data.attributes.map(attr => data.ratio[attr]),
                           type: 'bar',
                           marker: {color: '#8B4513'}
                       });
                   } else {
                       if (data['4chan']) {
                           traces.push({
                               x: data.attributes,
                               y: data.attributes.map(attr => data['4chan'][attr]),
                               name: '4chan',
                               type: 'bar',
                               marker: {color: '#dc3545'}
                           });
                       }
                       if (data['reddit']) {
                           traces.push({
                               x: data.attributes,
                               y: data.attributes.map(attr => data['reddit'][attr]),
                               name: 'Reddit',
                               type: 'bar',
                               marker: {color: '#28a745'}
                           });
                       }
                   }
                  
                   Plotly.newPlot('multi-chart', traces, {
                       title: showRatio ? 'Toxicity Ratios (4chan/Reddit)' : 'Multi-Attribute Comparison',
                       xaxis: {title: 'Toxicity Attribute'},
                       yaxis: {title: showRatio ? 'Ratio' : 'Mean Score'},
                       barmode: 'group'
                   });
               })
               .catch(error => {
                   hideLoading('multi-chart');
                   showError('multi-chart', 'Error: ' + error);
               });
       }
      
       // BONUS: TF-IDF
       function loadTFIDF() {
           const platform = document.getElementById('tfidf-platform').value;
           const threshold = document.getElementById('tfidf-threshold').value;
           const topN = document.getElementById('tfidf-topn').value;
          
           const url = `/api/tfidf-analysis?platform=${platform}&threshold=${threshold}&top_n=${topN}`;
           showLoading('tfidf-chart');
          
           fetch(url)
               .then(response => response.json())
               .then(data => {
                   hideLoading('tfidf-chart');
                  
                   if (data.error) {
                       showError('tfidf-chart', data.error);
                       return;
                   }
                  
                   const trace = {
                       x: data.scores,
                       y: data.top_words,
                       type: 'bar',
                       orientation: 'h',
                       marker: {color: '#8B4513'}
                   };
                  
                   Plotly.newPlot('tfidf-chart', [trace], {
                       title: `Top ${data.top_words.length} Toxic Words on ${data.platform}`,
                       xaxis: {title: 'TF-IDF Score'},
                       yaxis: {title: 'Word/Phrase', autorange: 'reversed'},
                       height: 600
                   });
                  
                   const interpDiv = document.getElementById('tfidf-interpretation');
                   interpDiv.style.display = 'block';
                   interpDiv.innerHTML = `
                       <strong>Analysis Results:</strong><br>
                       ${data.interpretation}<br><br>
                       <strong>Sample Size:</strong> Analyzed ${data.toxic_posts_analyzed.toLocaleString()} toxic posts and
                       ${data.nontoxic_posts_analyzed.toLocaleString()} non-toxic posts.
                   `;
               })
               .catch(error => {
                   hideLoading('tfidf-chart');
                   showError('tfidf-chart', 'Error: ' + error);
               });
       }
      
       // Collapse toggle icon rotation
       document.querySelectorAll('.collapse-toggle').forEach(toggle => {
           toggle.addEventListener('click', function() {
               this.classList.toggle('collapsed');
           });
       });
      
       // Auto-load on page load
       window.onload = function() {
           console.log('Dashboard loaded! Loading default charts...');
           loadToxicityDistribution();
           loadKeywordAnalysis();
           loadMultiAttribute();
       };
   </script>
</body>
</html>